<!DOCTYPE html>
<html>
<head>
    <title>RPS AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .choices button {
            font-size: 50px;
            width: 80px;
            height: 80px;
            border: none;
            background: #4285f4;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            margin: 10px;
        }
        #result {
            font-size: 24px;
            margin: 20px 0;
            min-height: 60px;
        }
        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        .stat-box {
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            min-width: 120px;
        }
        #loading {
            margin: 50px 0;
            font-size: 18px;
        }
        .win { color: green; }
        .lose { color: red; }
        .draw { color: orange; }
    </style>
</head>
<body>
    <h1>Rock Paper Scissors AI</h1>
    
    <div id="loading">Loading AI...</div>
    
    <div id="game" style="display:none;">
        <div class="choices">
            <button id="rock">✊</button>
            <button id="paper">✋</button>
            <button id="scissors">✌️</button>
        </div>
        
        <div id="result">Make your move!</div>
        
        <div class="stats">
            <div class="stat-box">
                <h3>You</h3>
                <p>Wins: <span id="user-wins">0</span></p>
                <p>Losses: <span id="user-losses">0</span></p>
            </div>
            <div class="stat-box">
                <h3>AI</h3>
                <p>Win Rate: <span id="ai-win-rate">0%</span></p>
                <p>Games: <span id="total-games">0</span></p>
            </div>
        </div>
    </div>

    <script>
        // Supabase setup - REPLACE WITH YOUR CREDENTIALS
        const supabaseUrl = 'YOUR_SUPABASE_URL';
        const supabaseKey = 'YOUR_SUPABASE_KEY';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
        
        // Game state
        const game = {
            userWins: 0,
            userLosses: 0,
            draws: 0,
            userModel: null,
            globalModel: null,
            ready: false
        };
        
        // Initialize game
        async function init() {
            try {
                await tf.ready();
                
                // Create models
                game.userModel = createModel();
                game.globalModel = createModel();
                
                // Load saved data
                await loadModels();
                
                // Setup UI
                document.getElementById('rock').onclick = () => play('rock');
                document.getElementById('paper').onclick = () => play('paper');
                document.getElementById('scissors').onclick = () => play('scissors');
                
                // Show game
                document.getElementById('loading').style.display = 'none';
                document.getElementById('game').style.display = 'block';
                game.ready = true;
                
            } catch (error) {
                document.getElementById('loading').textContent = 'Error loading AI. Please refresh.';
                console.error(error);
            }
        }
        
        // Simple neural network
        function createModel() {
            const model = tf.sequential();
            model.add(tf.layers.dense({units: 8, activation: 'relu', inputShape: [6]}));
            model.add(tf.layers.dense({units: 3, activation: 'softmax'}));
            model.compile({optimizer: 'adam', loss: 'categoricalCrossentropy'});
            return model;
        }
        
        // Play a round
        async function play(userMove) {
            if (!game.ready) return;
            
            // Get AI move
            const aiMove = await getAiMove(userMove);
            
            // Determine result
            const result = getResult(userMove, aiMove);
            updateGame(result);
            
            // Train after 5 moves
            if (game.userWins + game.userLosses + game.draws >= 5) {
                await trainModels();
            }
        }
        
        // AI move prediction
        async function getAiMove(userMove) {
            const moves = ['rock', 'paper', 'scissors'];
            
            // Start with random moves
            if (game.userWins + game.userLosses < 3) {
                return moves[Math.floor(Math.random() * 3)];
            }
            
            // Predict using models
            const input = createInput(userMove);
            const tensor = tf.tensor2d([input]);
            
            const userPred = await game.userModel.predict(tensor).array();
            const globalPred = await game.globalModel.predict(tensor).array();
            tensor.dispose();
            
            // Blend predictions
            const blended = [
                0.7 * userPred[0][0] + 0.3 * globalPred[0][0],
                0.7 * userPred[0][1] + 0.3 * globalPred[0][1],
                0.7 * userPred[0][2] + 0.3 * globalPred[0][2]
            ];
            
            // Sometimes random for exploration
            if (Math.random() < 0.1) return moves[Math.floor(Math.random() * 3)];
            
            return moves[blended.indexOf(Math.max(...blended))];
        }
        
        // Create input for prediction
        function createInput(userMove) {
            // Simplified input - just last 2 moves
            const input = [];
            const total = game.userWins + game.userLosses + game.draws;
            
            if (total > 0) {
                input.push(...encodeMove(userMove));
                input.push(game.userWins / total);
                input.push(game.userLosses / total);
            } else {
                input.push(0, 0, 0, 0.5, 0.5);
            }
            
            return input;
        }
        
        // Encode move as numbers
        function encodeMove(move) {
            return [
                move === 'rock' ? 1 : 0,
                move === 'paper' ? 1 : 0,
                move === 'scissors' ? 1 : 0
            ];
        }
        
        // Determine winner
        function getResult(user, ai) {
            if (user === ai) return 'draw';
            if ((user === 'rock' && ai === 'scissors') ||
                (user === 'paper' && ai === 'rock') ||
                (user === 'scissors' && ai === 'paper')) return 'win';
            return 'lose';
        }
        
        // Update game state and UI
        function updateGame(result) {
            if (result === 'win') game.userWins++;
            if (result === 'lose') game.userLosses++;
            if (result === 'draw') game.draws++;
            
            // Update UI
            document.getElementById('user-wins').textContent = game.userWins;
            document.getElementById('user-losses').textContent = game.userLosses;
            
            const total = game.userWins + game.userLosses;
            const winRate = total > 0 ? Math.round((game.userLosses / total) * 100) : 0;
            document.getElementById('ai-win-rate').textContent = winRate + '%';
            document.getElementById('total-games').textContent = total + game.draws;
            
            // Save game state
            localStorage.setItem('rps-game', JSON.stringify({
                wins: game.userWins,
                losses: game.userLosses,
                draws: game.draws
            }));
        }
        
        // Train models
        async function trainModels() {
            // In a real app, you'd implement proper training here
            // For simplicity, we'll just count this as training
            await saveModels();
        }
        
        // Load models
        async function loadModels() {
            // Load user data
            const saved = localStorage.getItem('rps-game');
            if (saved) {
                const data = JSON.parse(saved);
                game.userWins = data.wins || 0;
                game.userLosses = data.losses || 0;
                game.draws = data.draws || 0;
            }
            
            // Try to load global model from Supabase
            try {
                const { data } = await supabase
                    .from('global_models')
                    .select('model_data,total_games')
                    .eq('name', 'rps_global')
                    .single();
                
                if (data?.model_data) {
                    const artifacts = JSON.parse(atob(data.model_data));
                    await game.globalModel.load(artifacts);
                    document.getElementById('total-games').textContent = data.total_games || 0;
                }
            } catch (error) {
                console.log('No global model found');
            }
        }
        
        // Save models
        async function saveModels() {
            // Save user model to localStorage
            await game.userModel.save('localstorage://user-model');
            
            // Update global model in Supabase every 10 games
            if ((game.userWins + game.userLosses) % 10 === 0) {
                try {
                    const artifacts = await game.globalModel.save();
                    const modelData = btoa(JSON.stringify(artifacts));
                    
                    await supabase
                        .from('global_models')
                        .upsert({
                            name: 'rps_global',
                            model_data: modelData,
                            total_games: game.userWins + game.userLosses + game.draws,
                            updated_at: new Date().toISOString()
                        });
                } catch (error) {
                    console.error('Error saving global model:', error);
                }
            }
        }
        
        // Start the game
        window.onload = init;
    </script>
</body>
</html>
