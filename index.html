<!DOCTYPE html>
<html>
<head>
    <title>RPS AI</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        .choices button {
            font-size: 50px;
            width: 80px;
            height: 80px;
            border: none;
            background: #4285f4;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s;
        }
        .choices button:hover {
            transform: scale(1.1);
        }
        #result {
            font-size: 24px;
            margin: 20px 0;
            min-height: 60px;
        }
        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .stat-box {
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
            min-width: 120px;
        }
        #loading {
            margin: 50px 0;
            font-size: 18px;
        }
        .win { color: #2ecc71; }
        .lose { color: #e74c3c; }
        .draw { color: #f39c12; }
    </style>
</head>
<body>
    <h1>Rock Paper Scissors AI</h1>
    
    <div id="loading">Loading AI...</div>
    
    <div id="game" style="display:none;">
        <div class="choices">
            <button id="rock">✊</button>
            <button id="paper">✋</button>
            <button id="scissors">✌️</button>
        </div>
        
        <div id="result">Make your move!</div>
        
        <div class="stats">
            <div class="stat-box">
                <h3>You</h3>
                <p>Wins: <span id="user-wins">0</span></p>
                <p>Losses: <span id="user-losses">0</span></p>
            </div>
            <div class="stat-box">
                <h3>AI</h3>
                <p>Win Rate: <span id="ai-win-rate">0%</span></p>
                <p>Games: <span id="total-games">0</span></p>
            </div>
        </div>
    </div>

    <script>
        // Configuration - will be replaced during deployment
        const SUPABASE_URL = process.env.SUPABASE_URL || 'https://orpljgijsehehkbnfqpk.supabase.co';
        const SUPABASE_KEY = process.env.SUPABASE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ycGxqZ2lqc2VoZWhrYm5mcXBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDEyMTkzMTIsImV4cCI6MjA1Njc5NTMxMn0.QcdyYLwNlOGwN6yi67Sm6oEEX86AOtudP24yVlodpKg';
        
        // Game state
        const game = {
            userWins: 0,
            userLosses: 0,
            draws: 0,
            model: null,
            ready: false,
            supabase: null
        };
        
        // Initialize game
        async function init() {
            try {
                // Initialize Supabase with environment variables
                game.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Load TF.js
                await tf.ready();
                
                // Create model
                game.model = createModel();
                
                // Load saved data
                await loadData();
                
                // Setup UI
                setupControls();
                
                // Show game
                document.getElementById('loading').style.display = 'none';
                document.getElementById('game').style.display = 'block';
                game.ready = true;
                
            } catch (error) {
                document.getElementById('loading').textContent = 'Error loading. Please refresh.';
                console.error(error);
            }
        }
        
        // Create neural network
        function createModel() {
            const model = tf.sequential();
            model.add(tf.layers.dense({
                units: 8,
                activation: 'relu',
                inputShape: [4]
            }));
            model.add(tf.layers.dense({
                units: 3,
                activation: 'softmax'
            }));
            model.compile({
                optimizer: 'adam',
                loss: 'categoricalCrossentropy'
            });
            return model;
        }
        
        // Setup game controls
        function setupControls() {
            document.getElementById('rock').onclick = () => play('rock');
            document.getElementById('paper').onclick = () => play('paper');
            document.getElementById('scissors').onclick = () => play('scissors');
        }
        
        // Play a round
        async function play(userMove) {
            if (!game.ready) return;
            
            // Get AI move
            const aiMove = await getAiMove(userMove);
            
            // Determine result
            const result = getResult(userMove, aiMove);
            updateGame(result);
            
            // Train after 5 moves
            if (game.userWins + game.userLosses + game.draws >= 5) {
                await trainModel();
            }
        }
        
        // Get AI move
        async function getAiMove(userMove) {
            const moves = ['rock', 'paper', 'scissors'];
            
            // Start with random moves
            if (game.userWins + game.userLosses < 3) {
                return moves[Math.floor(Math.random() * 3)];
            }
            
            // Predict using model
            const input = createInput(userMove);
            const tensor = tf.tensor2d([input]);
            
            const prediction = await game.model.predict(tensor).array();
            tensor.dispose();
            
            // Sometimes random for exploration
            if (Math.random() < 0.1) return moves[Math.floor(Math.random() * 3)];
            
            return moves[prediction[0].indexOf(Math.max(...prediction[0]))];
        }
        
        // Create input for prediction
        function createInput(userMove) {
            // Simple input: last move and win ratio
            const input = [
                userMove === 'rock' ? 1 : 0,
                userMove === 'paper' ? 1 : 0,
                userMove === 'scissors' ? 1 : 0,
                game.userWins / (game.userWins + game.userLosses || 1)
            ];
            return input;
        }
        
        // Determine winner
        function getResult(user, ai) {
            if (user === ai) return 'draw';
            if ((user === 'rock' && ai === 'scissors') ||
                (user === 'paper' && ai === 'rock') ||
                (user === 'scissors' && ai === 'paper')) return 'win';
            return 'lose';
        }
        
        // Update game state
        function updateGame(result) {
            if (result === 'win') game.userWins++;
            if (result === 'lose') game.userLosses++;
            if (result === 'draw') game.draws++;
            
            // Update UI
            document.getElementById('user-wins').textContent = game.userWins;
            document.getElementById('user-losses').textContent = game.userLosses;
            
            const total = game.userWins + game.userLosses || 1;
            const winRate = Math.round((game.userLosses / total) * 100);
            document.getElementById('ai-win-rate').textContent = winRate + '%';
            document.getElementById('total-games').textContent = game.userWins + game.userLosses + game.draws;
            
            // Save game state
            localStorage.setItem('rps-game', JSON.stringify({
                wins: game.userWins,
                losses: game.userLosses,
                draws: game.draws
            }));
        }
        
        // Train model
        async function trainModel() {
            // In a real app, implement proper training here
            // For this example, we'll just simulate training
            console.log("Training model...");
            
            // Sync with Supabase every 10 games
            if ((game.userWins + game.userLosses) % 10 === 0) {
                await syncWithSupabase();
            }
        }
        
        // Load data
        async function loadData() {
            // Load local data
            const saved = localStorage.getItem('rps-game');
            if (saved) {
                const data = JSON.parse(saved);
                game.userWins = data.wins || 0;
                game.userLosses = data.losses || 0;
                game.draws = data.draws || 0;
            }
            
            // Try to load global model from Supabase
            try {
                const { data } = await game.supabase
                    .from('global_models')
                    .select('model_data,total_games')
                    .eq('name', 'rps_global')
                    .single();
                
                if (data?.model_data) {
                    const artifacts = JSON.parse(atob(data.model_data));
                    await game.model.load(artifacts);
                    document.getElementById('total-games').textContent = data.total_games || 0;
                }
            } catch (error) {
                console.log('No global model found');
            }
        }
        
        // Sync with Supabase
        async function syncWithSupabase() {
            try {
                const artifacts = await game.model.save();
                const modelData = btoa(JSON.stringify(artifacts));
                
                await game.supabase
                    .from('global_models')
                    .upsert({
                        name: 'rps_global',
                        model_data: modelData,
                        total_games: game.userWins + game.userLosses + game.draws,
                        updated_at: new Date().toISOString()
                    });
            } catch (error) {
                console.error('Error syncing with Supabase:', error);
            }
        }
        
        // Start the game
        window.onload = init;
    </script>
</body>
</html>
